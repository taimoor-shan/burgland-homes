<?php

/**
 * Single Community Template
 * 
 * Template for displaying individual community posts
 * 
 * @package Burgland_Homes
 */

get_header();
global $post;
$ids = Burgland_Homes_Gallery::get_gallery_images($post->ID, 'full');
$featured_image = wp_get_attachment_image_src(get_post_thumbnail_id(), "full");

// Get custom fields
$address = get_field('community_address');
$city = get_field('community_city');
$state = get_field('community_state');
$zip = get_field('community_zip');
$latitude = get_field('community_latitude');
$longitude = get_field('community_longitude');
$total_lots = get_field('community_total_lots');
$price_range = get_field('community_price_range');
$amenities = get_field('community_amenities');
$video_url = get_field('community_video_url');
$brochure = get_field('community_brochure');


// Parse amenities if it's a string
if (is_string($amenities)) {
  $amenities = array_filter(array_map('trim', explode("\n", $amenities)));
}

// Get community status
$status_terms = wp_get_post_terms(get_the_ID(), 'bh_community_status');
$status_label = '';
$status_class = 'primary';

if (!empty($status_terms) && !is_wp_error($status_terms)) {
  $status_label = $status_terms[0]->name;
  $status = $status_terms[0]->slug;

  switch ($status) {
    case 'active':
      $status_class = 'success';
      break;
    case 'selling-fast':
      $status_class = 'warning';
      break;
    case 'sold-out':
      $status_class = 'secondary';
      break;
    case 'coming-soon':
      $status_class = 'info';
      break;
  }
}

// Get related floor plans
$floor_plans = new WP_Query(array(
  'post_type' => 'bh_floor_plan',
  'posts_per_page' => -1,
  'meta_query' => array(
    array(
      'key' => 'floor_plan_community',
      'value' => get_the_ID(),
    ),
  ),
));

// Get available lots
$available_lots = new WP_Query(array(
  'post_type' => 'bh_lot',
  'posts_per_page' => -1,
  'meta_query' => array(
    array(
      'key' => 'lot_community',
      'value' => get_the_ID(),
    ),
  ),
  'tax_query' => array(
    array(
      'taxonomy' => 'bh_lot_status',
      'field' => 'slug',
      'terms' => 'available',
    ),
  ),
));
?>

<main id="site-main">
  <?php if (have_posts()): while (have_posts()): the_post(); ?>

      <article <?php post_class('community-single'); ?>>

        <div class="container">
          <div class="row mt-10">
            <div class="col-lg-8">
              <!-- Breadcrumb -->
                <nav aria-label="breadcrumb" class="mb-3">
                  <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                      <a href="<?php echo home_url(); ?>" class="text-info">Home</a>
                    </li>
                    <li class="breadcrumb-item">
                      <a href="<?php echo get_post_type_archive_link('bh_community'); ?>" class="text-info">Communities</a>
                    </li>
                    <li class="breadcrumb-item active text-dark" aria-current="page">
                      <?php the_title(); ?>
                    </li>
                  </ol>
                </nav>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-8">
              <!-- HERO HEADER -->
              <div class="left-content">
                <!-- Slider -->
                <div class="plugin-slider">

                  <?php if (!empty($ids) && is_array($ids)) : ?>

                    <div class="plugin-slider__swiperBaap">
                      <div class="plugin-slider__swiper swiper">
                        <div class="swiper-wrapper">

                          <?php foreach ($ids as $index => $image_data) : ?>
                            <div class="swiper-slide plugin-slider__slide">
                              <a href="<?php echo esc_url($image_data['url']); ?>" class="glightbox" data-gallery="community-gallery" data-title="<?php echo esc_attr($image_data['title'] ?: $image_data['alt'] ?: 'Gallery Image'); ?>">
                                <img
                                  src="<?php echo esc_url($image_data['url']); ?>"
                                  alt="<?php echo esc_attr($image_data['alt'] ?: ($image_data['title'] ?: 'Gallery Image')); ?>"
                                  class="plugin-slider__image">
                              </a>
                            </div>
                          <?php endforeach; ?>

                        </div>

                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                        <div class="swiper-pagination"></div>
                      </div>
                    </div>

                  <?php else : ?>

                    <!-- Fallback -->
                    <div
                      class="plugin-slider-fallback"
                      style="height:400px; background:url('<?php echo esc_url($featured_image[0]); ?>') center/cover no-repeat;">
                    </div>

                  <?php endif; ?>

                </div>

                <!-- Actions -->
                <div class="btn-group gap-2 d-flex" role="group" aria-label="Basic example">

                  <?php if ($brochure && is_array($brochure) && isset($brochure['url'])) : ?>
                    <a
                      href="<?php echo esc_url($brochure['url']); ?>"
                      class="btn btn-primary btn-lg flex-fill text-center"
                      download>
                      <i class="fa-solid fa-file-circle-check me-2"></i>
                      Brochure
                    </a>
                  <?php endif; ?>

                  <?php if (!empty($video_url)) : ?>
                    <a
                      href="<?php echo esc_url($video_url); ?>"
                      class="btn btn-primary btn-lg flex-fill video-lightbox"
                      data-type="video">
                      <i class="fa-solid fa-video me-2"></i>
                      Watch Video
                    </a>
                  <?php endif; ?>

                  <a
                    href="#community-map"
                    class="btn btn-primary btn-lg flex-fill text-center">
                    <i class="fa-solid fa-map-location-dot me-2"></i>Site Map
                  </a>

                </div>


                <!-- Title + Status -->
                <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                  <h1 class="mb-0 text-dark"><?php the_title(); ?></h1>
                </div>

                <!-- Location -->
                <?php if ($city && $state) : ?>
                  <p class="lead text-dark mb-1">
                    <i class="fa-solid fa-location-dot me-2"></i>
                    <?php echo esc_html("$city, $state"); ?>
                  </p>
                <?php endif; ?>

                <!-- Price -->
                <?php if ($price_range) : ?>
                  <p class="h4 text-dark fw-bold mb-0">
                    <?php echo esc_html($price_range); ?>
                  </p>
                <?php endif; ?>

              </div>
              <!-- Main Content -->
              <div class="main-content">

                <!-- Community Stats -->
                <?php if ($total_lots || $floor_plans->found_posts || $available_lots->found_posts): ?>
                  <div class="card mb-4">
                    <div class="card-body">
                      <h2 class="h5 card-title mb-3">Community Overview</h2>
                      <div class="row g-4 text-center">
                        <?php if ($total_lots): ?>
                          <div class="col-md-4">
                            <div class="p-3">
                              <i class="bi bi-geo-alt fs-1 text-primary d-block mb-2"></i>
                              <p class="h3 mb-1"><?php echo esc_html($total_lots); ?></p>
                              <p class="small text-muted mb-0">Total Lots</p>
                            </div>
                          </div>
                        <?php endif; ?>

                        <?php if ($floor_plans->found_posts): ?>
                          <div class="col-md-4">
                            <div class="p-3">
                              <i class="bi bi-layout fs-1 text-success d-block mb-2"></i>
                              <p class="h3 mb-1"><?php echo esc_html($floor_plans->found_posts); ?></p>
                              <p class="small text-muted mb-0">Floor Plans</p>
                            </div>
                          </div>
                        <?php endif; ?>

                        <?php if ($available_lots->found_posts): ?>
                          <div class="col-md-4">
                            <div class="p-3">
                              <i class="bi bi-check2-circle fs-1 text-info d-block mb-2"></i>
                              <p class="h3 mb-1"><?php echo esc_html($available_lots->found_posts); ?></p>
                              <p class="small text-muted mb-0">Available Now</p>
                            </div>
                          </div>
                        <?php endif; ?>
                      </div>
                    </div>
                  </div>
                <?php endif; ?>

                <!-- Description -->
                <div class="card mb-4">
                  <div class="card-body">
                    <h2 class="h5 card-title mb-3">About This Community</h2>
                    <div class="content">
                      <?php the_content(); ?>
                    </div>
                  </div>
                </div>

                <!-- Map Integration Hook -->
                <?php if ($latitude && $longitude): ?>
                  <div class="card mb-4">
                    <div class="card-body">
                      <h2 class="h5 card-title mb-3">Location</h2>
                      <div id="community-map"
                        data-lat="<?php echo esc_attr($latitude); ?>"
                        data-lng="<?php echo esc_attr($longitude); ?>"
                        data-address="<?php echo esc_attr($address); ?>"
                        style="height: 400px; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                        <div class="text-center">
                          <p class="text-muted mb-2">
                            <i class="bi bi-geo-alt fs-3 d-block mb-2"></i>
                            <?php if ($address): ?>
                              <?php echo esc_html($address); ?><br>
                            <?php endif; ?>
                            <?php echo esc_html($city . ', ' . $state . ' ' . $zip); ?>
                          </p>
                          <small class="text-muted">Map integration: Add your preferred map service here (Google Maps, Mapbox, Leaflet, etc.)</small>
                        </div>
                      </div>
                      <?php
                      // Hook for map integration
                      do_action('burgland_homes_after_community_map', get_the_ID(), $latitude, $longitude);
                      ?>
                    </div>
                  </div>
                <?php endif; ?>

                <!-- Amenities -->
                <?php if (!empty($amenities) && is_array($amenities)): ?>
                  <div class="card mb-4">
                    <div class="card-body">
                      <h2 class="h5 card-title mb-3">Community Amenities</h2>
                      <div class="row">
                        <?php foreach ($amenities as $amenity): ?>
                          <div class="col-md-6 mb-2">
                            <div class="d-flex align-items-center gap-2">
                              <i class="bi bi-check2-circle text-success"></i>
                              <span><?php echo esc_html($amenity); ?></span>
                            </div>
                          </div>
                        <?php endforeach; ?>
                      </div>
                    </div>
                  </div>
                <?php endif; ?>

                <!-- Video -->
                <?php if ($video_url): ?>
                  <div class="card mb-4">
                    <div class="card-body">
                      <h2 class="h5 card-title mb-3">Community Video</h2>
                      <div class="ratio ratio-16x9">
                        <?php echo wp_oembed_get($video_url); ?>
                      </div>
                    </div>
                  </div>
                <?php endif; ?>

                <!-- Floor Plans -->
                <?php if ($floor_plans->have_posts()): ?>
                  <div class="card mb-4">
                    <div class="card-body">
                      <h2 class="h5 card-title mb-4">Available Floor Plans</h2>
                      <div class="row g-4">
                        <?php while ($floor_plans->have_posts()): $floor_plans->the_post();
                          $fp_bedrooms = get_post_meta(get_the_ID(), 'floor_plan_bedrooms', true);
                          $fp_bathrooms = get_post_meta(get_the_ID(), 'floor_plan_bathrooms', true);
                          $fp_sqft = get_post_meta(get_the_ID(), 'floor_plan_square_feet', true);
                          $fp_price = get_post_meta(get_the_ID(), 'floor_plan_price', true);
                        ?>
                          <div class="col-md-6">
                            <div class="card h-100">
                              <?php if (has_post_thumbnail()): ?>
                                <a href="<?php the_permalink(); ?>">
                                  <?php the_post_thumbnail('medium', array('class' => 'card-img-top')); ?>
                                </a>
                              <?php endif; ?>
                              <div class="card-body">
                                <h3 class="h6 card-title">
                                  <a href="<?php the_permalink(); ?>" class="text-decoration-none"><?php the_title(); ?></a>
                                </h3>
                                <?php if ($fp_price): ?>
                                  <p class="text-primary fw-bold mb-2"><?php echo esc_html($fp_price); ?></p>
                                <?php endif; ?>
                                <div class="d-flex gap-3 text-muted small">
                                  <?php if ($fp_bedrooms): ?>
                                    <span><i class="bi bi-house-door"></i> <?php echo esc_html($fp_bedrooms); ?> Bed</span>
                                  <?php endif; ?>
                                  <?php if ($fp_bathrooms): ?>
                                    <span><i class="bi bi-droplet"></i> <?php echo esc_html($fp_bathrooms); ?> Bath</span>
                                  <?php endif; ?>
                                  <?php if ($fp_sqft): ?>
                                    <span><i class="bi bi-arrows-angle-expand"></i> <?php echo esc_html(number_format($fp_sqft)); ?> sq ft</span>
                                  <?php endif; ?>
                                </div>
                              </div>
                              <div class="card-footer bg-transparent">
                                <a href="<?php the_permalink(); ?>" class="btn btn-outline-primary btn-sm w-100">View Details</a>
                              </div>
                            </div>
                          </div>
                        <?php endwhile;
                        wp_reset_postdata(); ?>
                      </div>
                    </div>
                  </div>
                <?php endif; ?>

              </div>
            </div>
               <!-- Sidebar -->
              <div class="col-lg-4">
                <div class="sticky-top" style="top: 100px;">

                  <!-- Contact Card -->
                  <div class="card mb-4">
                    <div class="card-body">
                      <h3 class="h5 card-title mb-4">Interested in This Community?</h3>
                      <div class="d-grid gap-3">
                        <a href="#contact-form" class="btn btn-primary btn-lg">Schedule a Visit</a>
                        <a href="tel:8005550192" class="btn btn-outline-primary">
                          <i class="bi bi-telephone me-2"></i>
                          (800) 555-0192
                        </a>
                        <?php if ($brochure && is_array($brochure)): ?>
                          <a href="<?php echo esc_url($brochure['url']); ?>" class="btn btn-outline-secondary" download>
                            <i class="bi bi-download me-2"></i>
                            Download Brochure
                          </a>
                        <?php endif; ?>
                      </div>
                    </div>
                  </div>

                  <!-- Quick Info -->
                  <div class="card">
                    <div class="card-body">
                      <h3 class="h6 card-title mb-3">Quick Info</h3>
                      <ul class="list-unstyled mb-0">
                        <?php if ($available_lots->found_posts): ?>
                          <li class="mb-2">
                            <strong>Available Lots:</strong> <?php echo esc_html($available_lots->found_posts); ?>
                          </li>
                        <?php endif; ?>
                        <?php if ($price_range): ?>
                          <li class="mb-2">
                            <strong>Price Range:</strong> <?php echo esc_html($price_range); ?>
                          </li>
                        <?php endif; ?>
                        <?php if ($floor_plans->found_posts): ?>
                          <li class="mb-2">
                            <strong>Floor Plans:</strong> <?php echo esc_html($floor_plans->found_posts); ?>
                          </li>
                        <?php endif; ?>
                      </ul>
                    </div>
                  </div>

                </div>
              </div>

          </div>
        </div>

      </article>

  <?php endwhile;
  endif; ?>
</main>

<!-- Swiper JS Initialization Script -->
<script>
  /**
   * Hero Slider using Swiper.js
   * Full-screen responsive image slider
   */

  document.addEventListener('DOMContentLoaded', function() {
    const heroSlider = document.querySelector('.plugin-slider__swiper');
    if (!heroSlider) return;

    // Initialize Swiper
    const swiper = new Swiper('.plugin-slider__swiper', {
      // Basic settings
      loop: true,
      speed: 1000,
      effect: 'fade',
      fadeEffect: {
        crossFade: true
      },

      // Autoplay
      autoplay: {
        delay: 3000,
        disableOnInteraction: false,
        pauseOnMouseEnter: false
      },

      // Navigation arrows
      navigation: {
        nextEl: '.swiper-button-next',
        prevEl: '.swiper-button-prev',
      },

      // Pagination
      pagination: {
        el: '.swiper-pagination',
        clickable: true,
        dynamicBullets: true
      },

      // Responsive breakpoints
      breakpoints: {
        320: {
          spaceBetween: 0
        },
        768: {
          spaceBetween: 0
        },
        1024: {
          spaceBetween: 0
        }
      },

      // Accessibility
      a11y: {
        enabled: true,
        prevSlideMessage: 'Previous slide',
        nextSlideMessage: 'Next slide',
        firstSlideMessage: 'This is the first slide',
        lastSlideMessage: 'This is the last slide',
        paginationBulletMessage: 'Go to slide {{index}}'
      },

      // Keyboard control
      keyboard: {
        enabled: true,
        onlyInViewport: true
      },

      // Touch gestures
      touchRatio: 1,
      touchAngle: 45,
      grabCursor: false,
    });

    // Pause autoplay when page is not visible
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        swiper.autoplay.stop();
      } else {
        swiper.autoplay.start();
      }
    });

    // Optional: Add custom events
    swiper.on('slideChange', function() {
      console.log('Slide changed to:', swiper.activeIndex);
    });
  });
</script>

<!-- GLightbox Initialization -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize GLightbox for community image gallery
    const imageLightbox = GLightbox({
      selector: '.glightbox',
      skin: 'clean',
      width: '90vw',
      height: '90vh',
      autoplayVideos: false, // Disable autoplay for gallery
      // descPosition: 'bottom',
      zoomable: true,
      draggable: true,
      touchNavigation: true,
      loop: false,
      moreLength: 0,
      closeButton: true,
      startAt: 0,
      lightboxLabel: 'Gallery Image {current} of {total}',
      plyr: {
        css: 'https://cdn.plyr.io/3.6.8/plyr.css',
        js: 'https://cdn.plyr.io/3.6.8/plyr.js',
        config: {
          ratio: '16:9',
          fullscreen: {
            enabled: true,
            iosNative: true
          },
          youtube: {
            noCookie: true,
            rel: 0,
            showinfo: 0,
            iv_load_policy: 3
          },
          vimeo: {
            byline: false,
            portrait: false,
            title: false,
            transparent: false
          }
        }
      }
    });

    // Initialize GLightbox for video only
    const videoLightbox = GLightbox({
      selector: '.video-lightbox',
      skin: 'clean',
      width: '90vw',
      height: '90vh',
      autoplayVideos: true, // Enable autoplay for video
      zoomable: true,
      draggable: true,
      touchNavigation: true,
      loop: false,
      moreLength: 0,
      closeButton: true,
      startAt: 0,
      lightboxLabel: 'Video Player',
      plyr: {
        css: 'https://cdn.plyr.io/3.6.8/plyr.css',
        js: 'https://cdn.plyr.io/3.6.8/plyr.js',
        config: {
          ratio: '16:9',
          fullscreen: {
            enabled: true,
            iosNative: true
          },
          youtube: {
            noCookie: true,
            rel: 0,
            showinfo: 0,
            iv_load_policy: 3
          },
          vimeo: {
            byline: false,
            portrait: false,
            title: false,
            transparent: false
          }
        }
      }
    });
  });
</script>

<?php
get_footer();
?>